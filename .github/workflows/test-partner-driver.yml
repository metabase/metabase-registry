name: Test All Partner Drivers

on: push

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.value }}
    steps:
      - id: matrix
        run: |
          export CURRENT_VERSION=${{ vars.CURRENT_VERSION }}
          echo "value=[\"master\", \"release-x.${CURRENT_VERSION}.x\", \"$(($CURRENT_VERSION - 1))\"]" >> $GITHUB_OUTPUT
      - run: |
          echo "${{ steps.matrix.outputs.value }}"

  clickhouse:
    needs: [ setup ]
    name: ${{ matrix.value }}
    strategy:
      matrix:
        value: ${{fromJSON(needs.setup.outputs.matrix)}}
    uses: ./.github/workflows/callable-partner-driver.yml
    with:
      MB_REF: ${{ matrix.value }}
      PARTNER_REF: 'master'
      DRIVER: 'clickhouse'
      REPO: ClickHouse/metabase-clickhouse-driver
      DOCKER: true


  materialize:
    uses: ./.github/workflows/callable-partner-driver.yml
    with:
      MB_REF: 'master'
      PARTNER_REF: 'master'
      DRIVER: 'materialize'
      REPO: MaterializeInc/metabase-materialize-driver
      DOCKER: true

  ocient:
    uses: ./.github/workflows/callable-partner-driver.yml
    with:
      MB_REF: 'master'
      PARTNER_REF: 'master'
      DRIVER: 'ocient'
      REPO: Xeograph/metabase-ocient-driver
      DOCKER: false

  starburst:
    uses: ./.github/workflows/callable-partner-driver.yml
    with:
      MB_REF: 'master'
      PARTNER_REF: 'main'
      DRIVER: 'starburst'
      REPO: starburstdata/metabase-driver
      DOCKER: false
